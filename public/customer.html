<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      background: linear-gradient(135deg, #1d2671, #c33764);
      min-height: 100vh;
      color: #fff;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .price {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .logout-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
    }
  </style>
</head>

<body>

<!-- Logout -->
<button class="btn btn-dark logout-btn" onclick="logout()">ğŸšª Logout</button>

<div class="container py-5">

  <h2 class="text-center mb-4">ğŸ§ƒ Vending Machine</h2>

  <!-- ADDRESS SECTION -->
  <div class="card text-dark mb-4">
    <div class="card-body">
      <h5 class="mb-3">ğŸ“¦ Delivery Address</h5>

      <div class="mb-2">
        <input type="text" id="addrName" class="form-control" placeholder="Full Name" required>
      </div>

      <div class="mb-2">
        <input type="tel" id="addrPhone" class="form-control" placeholder="Phone Number" required>
      </div>

      <div class="mb-2">
        <textarea id="addrAddress" class="form-control" rows="2"
          placeholder="House / Street / Area" required></textarea>
      </div>

      <div class="row g-2">
        <div class="col">
          <input type="text" id="addrCity" class="form-control" placeholder="City" required>
        </div>
        <div class="col">
          <input type="text" id="addrPin" class="form-control" placeholder="PIN Code" required>
        </div>
      </div>
    </div>
  </div>

  <!-- ITEMS -->
  <div class="row g-4 justify-content-center">

    <!-- ITEM CARD TEMPLATE -->
    <script>
      function itemCard(name, emoji, desc, btn, price=1) {
        return `
          <div class="col-md-5">
            <div class="card text-dark p-4">
              <h5>${emoji} ${name}</h5>
              <p class="text-muted">${desc}</p>
              <div class="price">â‚¹${price}</div>
              <button class="btn ${btn} mt-3"
                onclick="buyItem('${name}', ${price})">
                Buy
              </button>
            </div>
          </div>
        `;
      }
    </script>

    <div id="items"></div>

  </div>
</div>

<script>
  // Render products
  document.getElementById("items").innerHTML =
    itemCard("Chips","ğŸŸ","Crunchy snack","btn-primary") +
    itemCard("Cold Drink","ğŸ¥¤","Chilled refreshment","btn-success") +
    itemCard("Chocolate","ğŸ«","Sweet treat","btn-warning") +
    itemCard("Kurkure","ğŸ¿","Masaledar snack","btn-danger") +
    itemCard("Laptop","ğŸ’»","Portable computer","btn-secondary") +
    itemCard("Biryani","ğŸ›","Aromatic rice dish","btn-info") +
    itemCard("Mutton","ğŸ–","Tender meat","btn-dark");

  /* -------- PAYMENT -------- */
  async function buyItem(item, amount) {

    // collect address
    const address =
      addrName.value + ", " +
      addrPhone.value + ", " +
      addrAddress.value + ", " +
      addrCity.value + " - " +
      addrPin.value;

    if (!addrName.value || !addrPhone.value || !addrAddress.value || !addrCity.value || !addrPin.value) {
      alert("Please fill address before buying");
      return;
    }

    const res = await fetch("/api/payments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include", // ğŸ”¥ IMPORTANT FOR SESSION
      body: JSON.stringify({ item, amount, address })
    });

    if (res.status === 401) {
      alert("Please login first");
      window.location.href = "/customer-login";
      return;
    }

    if (!res.ok) {
      alert("âŒ Payment failed");
      return;
    }

    alert("âœ… Payment successful!");
  }

  function logout() {
    window.location.href = "/";
  }
</script>

</body>
</html>
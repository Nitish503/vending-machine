<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: linear-gradient(135deg, #1d2671, #c33764);
      min-height: 100vh;
      color: #fff;
    }

    .card {
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .price {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .logout-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
    }
  </style>
</head>

<body>

<!-- Logout -->
<button class="btn btn-dark logout-btn" onclick="logout()">ğŸšª Logout</button>

<div class="container py-5">

  <h2 class="text-center mb-4">ğŸ§ƒ Vending Machine</h2>

  <!-- ADDRESS BUTTON -->
  <div class="text-center mb-4">
    <button class="btn btn-outline-light" onclick="toggleAddress()">
      ğŸ  Add / Update Address
    </button>
  </div>

  <!-- ADDRESS SECTION -->
  <div id="addressSection" class="card text-dark mb-4" style="display:none;">
    <div class="card-body">

      <h5 class="mb-3">ğŸ“¦ Delivery Address</h5>

      <form onsubmit="saveAddress(event)">
        <div class="mb-2">
          <input type="text" id="addrName" class="form-control" placeholder="Full Name" required>
        </div>

        <div class="mb-2">
          <input type="tel" id="addrPhone" class="form-control" placeholder="Phone Number" required>
        </div>

        <div class="mb-2">
          <textarea id="addrAddress" class="form-control" rows="2"
            placeholder="House / Street / Area" required></textarea>
        </div>

        <div class="row g-2 mb-3">
          <div class="col">
            <input type="text" id="addrCity" class="form-control" placeholder="City" required>
          </div>
          <div class="col">
            <input type="text" id="addrPin" class="form-control" placeholder="PIN Code" required>
          </div>
        </div>

        <button class="btn btn-success w-100">
          ğŸ’¾ Save Address
        </button>
      </form>

    </div>
  </div>

  <!-- ITEMS -->
  <div class="row g-4 justify-content-center">

    <!-- Chips -->
    <div class="col-md-5">
      <div class="card text-dark p-4">
        <h5>ğŸŸ Chips</h5>
        <p class="text-muted">Crunchy snack</p>
        <div class="price">â‚¹1</div>
        <button class="btn btn-primary mt-3"
          onclick="buyItem('Chips', 1)">
          Buy
        </button>
      </div>
    </div>
    <!-- Chocolate -->
<div class="col-md-5">
  <div class="card text-dark p-4">
    <h5>ğŸ« Chocolate</h5>
    <p class="text-muted">Sweet & delicious treat</p>
    <div class="price">â‚¹1</div>
    <button class="btn btn-warning mt-3"
      onclick="buyItem('Chocolate', 1)">
      Buy
    </button>
  </div>
</div>

<!-- Kurkure -->
<div class="col-md-5">
  <div class="card text-dark p-4">
    <h5>ğŸ¿ Kurkure</h5>
    <p class="text-muted">Masaledar crunchy snack</p>
    <div class="price">â‚¹1</div>
    <button class="btn btn-danger mt-3"
      onclick="buyItem('Kurkure', 1)">
      Buy
    </button>
  </div>
</div>
<!-- Laptop -->
<div class="col-md-5">
  <div class="card text-dark p-4">
    <h5>ğŸ’» Laptop</h5>
    <p class="text-muted">High-performance portable computer</p>
    <div class="price">â‚¹1</div>
    <button class="btn btn-secondary mt-3"
      onclick="buyItem('Laptop', 1)">
      Buy
    </button>
  </div>
</div>
<!-- Biryani -->
<div class="col-md-5">
  <div class="card text-dark p-4">
    <h5>ğŸ› Biryani</h5>
    <p class="text-muted">Aromatic rice with rich spices</p>
    <div class="price">â‚¹1</div>
    <button class="btn btn-info mt-3"
      onclick="buyItem('Biryani', 1)">
      Buy
    </button>
  </div>
</div>

<!-- Mutton -->
<div class="col-md-5">
  <div class="card text-dark p-4">
    <h5>ğŸ– Mutton</h5>
    <p class="text-muted">Tender & flavorful meat dish</p>
    <div class="price">â‚¹1</div>
    <button class="btn btn-dark mt-3"
      onclick="buyItem('Mutton', 1)">
      Buy
    </button>
  </div>
</div>

    <!-- Cold Drink -->
    <div class="col-md-5">
      <div class="card text-dark p-4">
        <h5>ğŸ¥¤ Cold Drink</h5>
        <p class="text-muted">Chilled refreshment</p>
        <div class="price">â‚¹1</div>
        <button class="btn btn-success mt-3"
          onclick="buyItem('Cold Drink', 1)">
          Buy
        </button>
      </div>
    </div>

  </div>
</div>

<script>
  // Ensure customer logged in
  const customerId = localStorage.getItem("customer_id");
  if (!customerId) {
    alert("Please login again");
    window.location.href = "/customer-login";
  }

  /* -------- ADDRESS LOGIC -------- */
  function toggleAddress() {
    const section = document.getElementById("addressSection");
    section.style.display = section.style.display === "none" ? "block" : "none";

    const saved = JSON.parse(localStorage.getItem("customerAddress"));
    if (saved) {
      addrName.value = saved.name;
      addrPhone.value = saved.phone;
      addrAddress.value = saved.address;
      addrCity.value = saved.city;
      addrPin.value = saved.pin;
    }
  }

  function saveAddress(e) {
    e.preventDefault();

    const address = {
      name: addrName.value,
      phone: addrPhone.value,
      address: addrAddress.value,
      city: addrCity.value,
      pin: addrPin.value
    };

    localStorage.setItem("customerAddress", JSON.stringify(address));
    alert("âœ… Address saved successfully");
    document.getElementById("addressSection").style.display = "none";
  }

  /* -------- PAYMENT -------- */
  function buyItem(item, amount) {
  const customerId = localStorage.getItem("customer_id");
  const address = localStorage.getItem("customerAddress");

  if (!address) {
    alert("Please add address before buying");
    return;
  }

  fetch("/api/payments", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      customer_id: customerId,
      item: item,
      amount: amount,
      address: address
    })
  })
  .then(res => res.json())
  .then(() => {
    alert("âœ… Payment successful!");
  })
  .catch(() => {
    alert("âŒ Payment failed");
  });
}

  function logout() {
    localStorage.removeItem("customer_id");
    window.location.href = "/";
  }
</script>

</body>
</html>